<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body { font-family: sans-serif; background: #111; color: #eee; }
  svg { background: #1e1e1e; cursor: crosshair; }
  .axis path, .axis line { stroke: #888; }
  .tooltip {
    position: absolute;
    background: rgba(20, 20, 20, 0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    pointer-events: none;
    font-size: 12px;
  }
</style>

<body>
<div id="chart"></div>
<div class="tooltip" style="opacity:0;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = [
  { date: new Date('2025-10-21'), open: 101, high: 108, low: 99, close: 104 },
  { date: new Date('2025-10-22'), open: 104, high: 110, low: 102, close: 106 },
  { date: new Date('2025-10-23'), open: 106, high: 107, low: 100, close: 101 },
  { date: new Date('2025-10-24'), open: 101, high: 105, low: 99, close: 103 },
  { date: new Date('2025-10-25'), open: 103, high: 111, low: 102, close: 110 },
  { date: new Date('2025-10-26'), open: 110, high: 115, low: 108, close: 112 },
  { date: new Date('2025-10-27'), open: 112, high: 116, low: 110, close: 114 },
  { date: new Date('2025-10-28'), open: 114, high: 117, low: 112, close: 115 },
  { date: new Date('2025-10-29'), open: 115, high: 119, low: 113, close: 118 },
  { date: new Date('2025-10-30'), open: 118, high: 121, low: 116, close: 120 }
];

const margin = {top: 20, right: 40, bottom: 30, left: 50};
const width = 900 - margin.left - margin.right;
const height = 500 - margin.top - margin.bottom;

const svg = d3.select("#chart").append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom);

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

const tooltip = d3.select(".tooltip");

const x = d3.scaleBand().domain(data.map(d => d.date)).range([0, width]).padding(0.3);
const y = d3.scaleLinear()
  .domain([d3.min(data, d => d.low), d3.max(data, d => d.high)])
  .nice().range([height, 0]);

const xAxis = g.append("g")
  .attr("class", "axis")
  .attr("transform", `translate(0,${height})`)
  .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %d")));

const yAxis = g.append("g")
  .attr("class", "axis")
  .call(d3.axisLeft(y));

// Group for candles
const candleGroup = g.append("g");

// Wick lines
const wicks = candleGroup.selectAll(".wick")
  .data(data)
  .enter()
  .append("line")
  .attr("class", "wick")
  .attr("stroke", "#999");

// Candle bodies
const candles = candleGroup.selectAll(".candle")
  .data(data)
  .enter()
  .append("rect")
  .attr("class", "candle")
  .attr("rx", 1)
  .attr("ry", 1);

// Crosshair line
const crosshair = g.append("line")
  .attr("stroke", "#777")
  .attr("y1", 0)
  .attr("y2", height)
  .attr("opacity", 0);

// Draw function
function drawChart() {
  wicks
    .attr("x1", d => x(d.date) + x.bandwidth() / 2)
    .attr("x2", d => x(d.date) + x.bandwidth() / 2)
    .attr("y1", d => y(d.high))
    .attr("y2", d => y(d.low));

  candles
    .attr("x", d => x(d.date))
    .attr("y", d => y(Math.max(d.open, d.close)))
    .attr("width", x.bandwidth())
    .attr("height", d => Math.abs(y(d.open) - y(d.close)))
    .attr("fill", d => d.close > d.open ? "#00c176" : "#ff3b3b");
}

drawChart();

// Tooltip + crosshair interaction
svg.on("mousemove", (event) => {
  const [mouseX, mouseY] = d3.pointer(event);
  const x0 = x.invert ? x.invert(mouseX - margin.left) : null;
  const i = Math.floor((mouseX - margin.left) / x.step());
  const d = data[i];
  if (!d) return;

  crosshair
    .attr("x1", x(d.date) + x.bandwidth() / 2)
    .attr("x2", x(d.date) + x.bandwidth() / 2)
    .attr("opacity", 1);

  tooltip.transition().duration(100).style("opacity", 0.9);
  tooltip.html(
    `Date: ${d3.timeFormat("%b %d, %Y")(d.date)}<br/>
     Open: ${d.open}<br/>
     High: ${d.high}<br/>
     Low: ${d.low}<br/>
     Close: ${d.close}`
  )
  .style("left", (event.pageX + 10) + "px")
  .style("top", (event.pageY - 40) + "px");
});

svg.on("mouseleave", () => {
  crosshair.attr("opacity", 0);
  tooltip.transition().duration(300).style("opacity", 0);
});

// Zoom behavior
const zoom = d3.zoom()
  .scaleExtent([1, 20])
  .translateExtent([[0, 0], [width, height]])
  .extent([[0, 0], [width, height]])
  .on("zoom", (event) => {
    const t = event.transform;
    const zx = t.rescaleX(d3.scaleTime()
      .domain(d3.extent(data, d => d.date))
      .range([0, width]));

    const newBandwidth = (x.bandwidth() * t.k > 1) ? x.bandwidth() * t.k : 1;
    x.range([0, width].map(d => t.applyX(d)));

    drawChart();
    xAxis.call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b %d")));
  });

svg.call(zoom);
</script>
</body>
